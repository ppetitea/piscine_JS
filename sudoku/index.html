<!DOCTYPE html>
<html>
    <head>
        <title>sudoku</title>
        <link rel="stylesheet" href="css/sudoku.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    </head>
    <body>
        <header>
            <a href=""><h1 class="text">Sudoku</h1></a>
        </header>
        <div class="border">
            <div class="grid">
                <div class="subgrid">
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                </div>
                <div class="subgrid">
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                </div>
                <div class="subgrid">
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                </div>
                <div class="subgrid">
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                </div>
                <div class="subgrid">
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                </div>
                <div class="subgrid">
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                </div>
                <div class="subgrid">
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                </div>
                <div class="subgrid">
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                </div>
                <div class="subgrid">
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                    <div class="box"><p class="number"></p></div>
                </div>
            </div>
        </div>
        <div class="controls">
            <input type="image" id="reset" class="button" alt="reset" src="./resources/refresh.svg">
            <input type="image" id="check" class="button" alt="check" src="./resources/check.svg">
            <input type="image" id="new" class="button" alt="new" src="./resources/move.svg">
        </div>
    </body>
    <script type="module">
        import Sudoku from './modules/sudoku.mjs';
        import {deep_copy_2d, limit} from './modules/utils.mjs';


        let game = new Sudoku();

        function    convert_coor(x, y)
        {
            return {'x': (x % 3) + (y % 3) * 3, 'y': parseInt(x / 3) + parseInt(y / 3) * 3};
        }
        function    update_map_view()
        {
            for (let y = 0; y < 9; y++)
            {
                for (let x = 0; x < 9; x++)
                {
                    let coor = convert_coor(x, y);
                    $(".subgrid:eq("+coor.y+") .box:eq("+coor.x+") p").removeClass("editable");
                    $(".subgrid:eq("+coor.y+") .box:eq("+coor.x+") p").html(game.map[y][x]);
                    if (game.epur_map[y][x] == ' ')
                    {
                        $(".subgrid:eq("+coor.y+") .box:eq("+coor.x+") p").attr('contenteditable','true');
                        $(".subgrid:eq("+coor.y+") .box:eq("+coor.x+") p").addClass("editable");
                    }
                    else
                        $(".subgrid:eq("+coor.y+") .box:eq("+coor.x+") p").attr('contenteditable','false');
                }
            }
        }
        
        update_map_view();
        $(".number").on('focus', function() {
            $(this).removeClass("valid invalid");
            $(this).parent(".box").addClass('focus');                      
        })
        $(".number").on('focusout', function() {
            $(this).parent(".box").removeClass('focus');                      
        })
        $(".number").on('input', function() {
            let x = $(this).parent(".box").index();
            let y = $(this).parent(".box").parent(".subgrid").index();
            let coor = convert_coor(x, y);
            let number = parseInt($(this).html().replace(game.map[coor.y][coor.x], ''));
            if (Number.isInteger(number) && number > 0 && number <= 9)
            {
                game.map[coor.y][coor.x] = number;
                game.saveSudoku();
                update_map_view();
            }
            else
                $(this).html(' ');
        })
        $("#reset").on('click', function(){
            $(".result").remove();
            game.map = deep_copy_2d(game.epur_map);
            game.saveSudoku();
            update_map_view();
        })
        $("#check").on('click', function(){
            $(".result").remove();
            game.result.win = true;            
            for (let y = 0; y < 9; y++)
            {
                for (let x = 0; x < 9; x++)
                {
                    let coor = convert_coor(x, y);
                    if (game.epur_map[y][x] == ' ' && game.valid_map[y][x] == game.map[y][x])
                        $(".subgrid:eq("+coor.y+") .box:eq("+coor.x+") p").addClass("valid");
                    else if (game.epur_map[y][x] == ' ' )
                        $(".subgrid:eq("+coor.y+") .box:eq("+coor.x+") p").addClass("invalid");
                    if (game.valid_map[y][x] != game.map[y][x])
                        game.result.win = false;
                }
            }
            if (game.result.win == true)
                $("body").append("<p class=\"text result\" >Congratulation You Win !</p>");
            else
                $("body").append("<p class=\"text result\" >You're almost there..</p>");
        })
        $("#new").on('click', function(){
            $(".result").remove();
            $(".number").removeClass("valid invalid");            
            game.newSudoku();
            update_map_view();
        })
        document.addEventListener('keydown', (event) => {
            let x = $(document.activeElement).parent(".box").index();
            let y = $(document.activeElement).parent(".box").parent(".subgrid").index();
            if (x < 0 || x >= 9 || y < 0 || y >= 9)
            {
                x = 0;
                y = 0;
            }
            let coor = convert_coor(x, y);
            let vec = {'x': 0, 'y': 0};
            if (event.key == 'ArrowUp')
                vec.y = -1;
            if (event.key == 'ArrowRight')
                vec.x = 1;
            if (event.key == 'ArrowDown')
                vec.y = 1;
            if (event.key == 'ArrowLeft')
                vec.x = -1;

            let i = 1;
            while (i < 10)
            {
                x = limit(coor.x + vec.x * i, 0, 9);
                y = limit(coor.y + vec.y * i, 0, 9);
                if (game.epur_map[y][x] == ' ')
                    break;
                i++;
            }
            coor = convert_coor(x, y);
            $(".subgrid:eq("+coor.y+") .box:eq("+coor.x+") p").focus();
        })
    </script>
</html>